# ~/.zsh_welcome
# ==============================================================================
#  Unified Welcome & Environment Overview Script
# ==============================================================================
# Cross-platform welcome message for macOS, Linux, and WSL.
#
# VERBOSITY CONTROL (set in ~/.zshrc or ~/.zshrc.private):
#   ZSH_WELCOME          - Environment overview: "full", "minimal", "none", or "" (auto)
#   ZSH_WELCOME_QUICKREF - Quick reference: "full", "minimal", "none"
#   ZSH_WELCOME_DISK_WARN - Disk warning threshold percentage (default: 90)
#
# AUTO-DETECTION:
#   When ZSH_WELCOME="" (empty/unset), automatically uses:
#   - "minimal" for SSH sessions ($SSH_CONNECTION)
#   - "minimal" for tmux sessions ($TMUX)
#   - "full" otherwise
#
# Date Created: 16/01/2025
# ==============================================================================

# ------------------------------------------------------------------------------
# Verbosity Resolution
# ------------------------------------------------------------------------------
_resolve_welcome_verbosity() {
    # If explicitly set, use that value
    if [[ -n "$ZSH_WELCOME" ]]; then
        echo "$ZSH_WELCOME"
        return
    fi

    # Auto-detect: SSH session ‚Üí minimal
    if [[ -n "$SSH_CONNECTION" ]]; then
        echo "minimal"
        return
    fi

    # Auto-detect: tmux session ‚Üí minimal
    if [[ -n "$TMUX" ]]; then
        echo "minimal"
        return
    fi

    # Default: full
    echo "full"
}

# Store resolved verbosity
_WELCOME_VERBOSITY=$(_resolve_welcome_verbosity)
: ${ZSH_WELCOME_QUICKREF:="full"}
: ${ZSH_WELCOME_DISK_WARN:=90}

# ------------------------------------------------------------------------------
# Helper: Get Disk Usage
# ------------------------------------------------------------------------------
_get_disk_usage() {
    local usage_pct free_space

    if [[ "$IS_MAC" == "true" ]]; then
        # macOS: use df on root volume
        usage_pct=$(df -h / | awk 'NR==2 {gsub(/%/,""); print $5}')
        free_space=$(df -h / | awk 'NR==2 {print $4}')
    else
        # Linux/WSL: use df on home directory
        usage_pct=$(df -h ~ | awk 'NR==2 {gsub(/%/,""); print $5}')
        free_space=$(df -h ~ | awk 'NR==2 {print $4}')
    fi

    echo "${usage_pct}:${free_space}"
}

# ------------------------------------------------------------------------------
# Helper: Check GPU Availability (WSL/Linux only)
# ------------------------------------------------------------------------------
_check_gpu() {
    if command -v nvidia-smi &>/dev/null && nvidia-smi &>/dev/null; then
        echo "available"
    else
        echo "none"
    fi
}

# ------------------------------------------------------------------------------
# Full Welcome Display
# ------------------------------------------------------------------------------
_show_welcome_full() {
    echo

    # --- OS Header ---
    if [[ "$IS_MAC" == "true" ]]; then
        echo "${info}üõ°Ô∏è  macOS Environment Overview:${done}"
        echo "    macOS: $(sw_vers -productVersion 2>/dev/null || echo 'Unknown') (${MAC_ARCH:-$(uname -m)})"
    elif [[ "$IS_WSL" == "true" ]]; then
        echo "${info}üõ°Ô∏è  WSL Environment Overview:${done}"
        if command -v lsb_release &>/dev/null; then
            echo "    Distro: $(lsb_release -ds 2>/dev/null)"
        fi
        echo "    Kernel: $(uname -r)"
    else
        echo "${info}üõ°Ô∏è  Linux Environment Overview:${done}"
        if command -v lsb_release &>/dev/null; then
            echo "    Distro: $(lsb_release -ds 2>/dev/null)"
        fi
        echo "    Kernel: $(uname -r)"
    fi

    # --- Disk Space ---
    local disk_info=$(_get_disk_usage)
    local disk_pct="${disk_info%%:*}"
    local disk_free="${disk_info##*:}"

    if [[ "$disk_pct" -ge "$ZSH_WELCOME_DISK_WARN" ]]; then
        echo "    Disk: ${warn}${disk_pct}% used${done} (${disk_free} free) ‚ö†Ô∏è"
    else
        echo "    Disk: ${disk_pct}% used (${disk_free} free)"
    fi

    # --- uv (Python) ---
    if command -v uv &>/dev/null; then
        local uv_version=$(uv --version 2>/dev/null | awk '{print $2}')
        local uv_python_path=""
        if command -v get_uv_python_path &>/dev/null; then
            uv_python_path=$(get_uv_python_path "${PYTHON_DEFAULT_VERSION}" 2>/dev/null)
        fi
        if [[ -n "$uv_python_path" && -x "$uv_python_path" ]]; then
            local uv_python_version=$("$uv_python_path" --version 2>/dev/null)
            echo "    uv: ${ok}${uv_version}${done} (Python ${PYTHON_DEFAULT_VERSION}: ${uv_python_version})"
        else
            echo "    uv: ${ok}${uv_version}${done} (Python ${PYTHON_DEFAULT_VERSION}: ${warn}not installed${done})"
        fi
    else
        echo "    uv: ${err}Not Found${done}"
    fi

    # --- Node.js ---
    if command -v nvm &>/dev/null; then
        local active_node=$(nvm current 2>/dev/null)
        if [[ "$active_node" == "none" || -z "$active_node" ]]; then
            local default_node=$(nvm version default 2>/dev/null)
            echo "    Node: ${warn}None active${done} (default: ${default_node:-N/A})"
        else
            local npm_ver=$(npm -v 2>/dev/null || echo 'N/A')
            local pnpm_ver=$(pnpm -v 2>/dev/null || echo 'N/A')
            echo "    Node: ${ok}${active_node}${done} (npm: ${npm_ver}, pnpm: ${pnpm_ver})"
        fi
    else
        echo "    Node: ${err}nvm not found${done}"
    fi

    # --- Docker ---
    if command -v docker &>/dev/null && docker ps &>/dev/null 2>&1; then
        echo "    Docker: ${ok}Running${done}"
    elif command -v docker &>/dev/null; then
        if [[ "$IS_MAC" == "true" ]]; then
            echo "    Docker: ${warn}Not Running${done}"
        else
            echo "    Docker: ${warn}Not Running${done} (try: sudo usermod -aG docker \$USER)"
        fi
    else
        echo "    Docker: ${err}Not Installed${done}"
    fi

    # --- Homebrew (macOS only) ---
    if [[ "$IS_MAC" == "true" ]]; then
        if command -v brew &>/dev/null; then
            echo "    Homebrew: ${ok}OK${done}"
        else
            echo "    Homebrew: ${err}Not Found${done}"
        fi
    fi

    # --- GPU (WSL/Linux only) ---
    if [[ "$IS_WSL" == "true" || "$IS_LINUX" == "true" ]]; then
        local gpu_status=$(_check_gpu)
        if [[ "$gpu_status" == "available" ]]; then
            echo "    GPU: ${ok}NVIDIA Available${done}"
        else
            echo "    GPU: ${warn}Not Detected${done}"
        fi
    fi
}

# ------------------------------------------------------------------------------
# Minimal Welcome Display (Single Line)
# ------------------------------------------------------------------------------
_show_welcome_minimal() {
    local parts=()

    # OS
    if [[ "$IS_MAC" == "true" ]]; then
        parts+=("macOS ${MAC_ARCH:-$(uname -m)}")
    elif [[ "$IS_WSL" == "true" ]]; then
        parts+=("WSL")
    else
        parts+=("Linux")
    fi

    # Disk
    local disk_info=$(_get_disk_usage)
    local disk_pct="${disk_info%%:*}"
    if [[ "$disk_pct" -ge "$ZSH_WELCOME_DISK_WARN" ]]; then
        parts+=("${warn}Disk ${disk_pct}%${done}")
    else
        parts+=("Disk ${disk_pct}%")
    fi

    # uv
    if command -v uv &>/dev/null; then
        parts+=("${ok}uv ‚úì${done}")
    else
        parts+=("${err}uv ‚úó${done}")
    fi

    # Node
    if command -v nvm &>/dev/null; then
        local node_ver=$(nvm current 2>/dev/null)
        if [[ -n "$node_ver" && "$node_ver" != "none" ]]; then
            parts+=("${ok}Node ${node_ver%%.*}${done}")
        else
            parts+=("${warn}Node -${done}")
        fi
    else
        parts+=("${err}Node ‚úó${done}")
    fi

    # Docker
    if command -v docker &>/dev/null && docker ps &>/dev/null 2>&1; then
        parts+=("${ok}Docker ‚úì${done}")
    else
        parts+=("${warn}Docker -${done}")
    fi

    # Homebrew (Mac only)
    if [[ "$IS_MAC" == "true" ]]; then
        if command -v brew &>/dev/null; then
            parts+=("${ok}Brew ‚úì${done}")
        fi
    fi

    # GPU (WSL/Linux only)
    if [[ "$IS_WSL" == "true" || "$IS_LINUX" == "true" ]]; then
        if [[ "$(_check_gpu)" == "available" ]]; then
            parts+=("${ok}GPU ‚úì${done}")
        fi
    fi

    echo "üõ°Ô∏è  ${(j: | :)parts}"
}

# ------------------------------------------------------------------------------
# Quick Reference ‚Äî Full
# ------------------------------------------------------------------------------
_show_quickref_full() {
    echo
    echo "${info}üöÄ  Quick Reference:${done}"
    echo "    Python:  python_new_project, python_setup, python_delete"
    echo "    Node:    node_new_project, node_setup, node_clean"
    echo "    Docker:  docker_help | Tmux: tdev, gs, gstatus"
    echo "    Media:   yt --help"
}

# ------------------------------------------------------------------------------
# Quick Reference ‚Äî Minimal (Compact 2 Lines)
# ------------------------------------------------------------------------------
_show_quickref_minimal() {
    echo
    echo "${info}üí° Python: python_new_project | Node: node_new_project | Docker: docker_help${done}"
    echo "   Tmux: tdev, gs | Media: yt --help"
}

# ------------------------------------------------------------------------------
# Main Execution
# ------------------------------------------------------------------------------

# Show welcome based on verbosity
case "$_WELCOME_VERBOSITY" in
    full)
        _show_welcome_full
        ;;
    minimal)
        _show_welcome_minimal
        ;;
    none|"")
        # No welcome output
        ;;
esac

# Show quick reference based on its own verbosity setting
# (Only show if welcome is not 'none' ‚Äî if user wants no welcome, probably wants no quickref either)
if [[ "$_WELCOME_VERBOSITY" != "none" ]]; then
    case "$ZSH_WELCOME_QUICKREF" in
        full)
            _show_quickref_full
            ;;
        minimal)
            _show_quickref_minimal
            ;;
        none|"")
            # No quick reference output
            ;;
    esac
fi

# Add blank line for spacing (only if we showed something)
if [[ "$_WELCOME_VERBOSITY" != "none" ]]; then
    echo
fi

# ------------------------------------------------------------------------------
# uv Python Install Prompt
# ------------------------------------------------------------------------------
# Only prompt if:
# 1. Welcome verbosity is 'full' (not in SSH/tmux quick mode)
# 2. Shell is interactive
# 3. Python version is actually missing
if [[ "$_WELCOME_VERBOSITY" == "full" ]]; then
    if command -v get_uv_python_path &>/dev/null && ! get_uv_python_path "${PYTHON_DEFAULT_VERSION}" &>/dev/null; then
        echo "${warn}‚ö†Ô∏è  Default Python (${PYTHON_DEFAULT_VERSION}) not found in 'uv' cache.${done}"
        if [[ -t 1 ]]; then
            read "REPLY?    üëâ Would you like to run 'uv python install python@${PYTHON_DEFAULT_VERSION}' now? [y/N] "
            case "$REPLY" in
                [yY][eE][sS]|[yY])
                    uv python install "python@${PYTHON_DEFAULT_VERSION}"
                    ;;
                *)
                    echo "${warn}    Skipping 'uv' Python installation.${done}"
                    ;;
            esac
        fi
    fi
fi

# Cleanup internal variables
unset _WELCOME_VERBOSITY

# ~/.zsh_node_functions
# Source this file in ~/.zshrc

# ==============================================================================
# Helper Functions for Node.js Projects
# ==============================================================================

# --- Internal Helpers ---

# Get project name from package.json (requires jq)
_get_node_project_name() {
    if [[ ! -f "package.json" ]]; then return 1; fi
    jq -r '.name // ""' package.json 2>/dev/null
}

# Display runnable scripts from package.json
# Returns silently if no package.json or no jq
_display_node_scripts() {
    if [[ ! -f "package.json" ]] || ! command -v jq &>/dev/null; then
        return 0
    fi

    local -a script_names
    script_names=("${(@f)$(jq -r '.scripts // {} | keys[]' package.json 2>/dev/null)}")

    if (( ${#script_names[@]} > 0 )); then
        echo "--------------------------------------------------"
        echo "${info}Found ${ok}${#script_names[@]}${info} script(s) in package.json:${done}"
        for name in "${script_names[@]}"; do
            local cmd
            cmd=$(jq -r --arg n "$name" '.scripts[$n] // ""' package.json 2>/dev/null)
            echo "   ${ok}pnpm ${name}${done}  ${info}# ${cmd}${done}"
        done
    fi
}

# Display hints about the current Node.js project
_display_node_hints() {
    echo "${info}Hint: Project environment details:${done}"

    # .nvmrc content
    if [[ -f ".nvmrc" ]]; then
        echo "${info}      - .nvmrc version: ${ok}$(cat .nvmrc)${done}"
    else
        echo "${warn}      - No .nvmrc file found${done}"
    fi

    # engines.node from package.json
    if [[ -f "package.json" ]] && command -v jq &>/dev/null; then
        local engines_node
        engines_node=$(jq -r '.engines.node // empty' package.json 2>/dev/null)
        if [[ -n "$engines_node" ]]; then
            echo "${info}      - engines.node: ${ok}${engines_node}${done}"
        fi
    fi

    # Detected package manager from lockfile
    if [[ -f "pnpm-lock.yaml" ]]; then
        echo "${info}      - Package manager: ${ok}pnpm${done}"
    elif [[ -f "yarn.lock" ]]; then
        echo "${info}      - Package manager: ${ok}yarn${done}"
    elif [[ -f "package-lock.json" ]]; then
        echo "${info}      - Package manager: ${ok}npm${done}"
    fi

    # Available scripts
    _display_node_scripts
}

# --- Environment ---

# Check for a default NVM install and prompt if missing.
nvm_check_and_install_lts() {
    if ! command -v nvm &>/dev/null || [[ "$(nvm version default)" != "N/A" ]]; then
        return 0
    fi

    echo "${warn}No default Node.js version is set via nvm.${done}"
    if [[ -t 1 ]]; then
        read "REPLY?${info}    Would you like to install the latest LTS version and set it as default? [y/N] ${done}"
        if [[ "$REPLY" =~ ^[Yy]$ ]]; then
            echo "${info}Installing Node.js LTS...${done}"
            nvm install --lts
            nvm alias default 'lts/*'
            echo "${ok}Node.js LTS installed and set as default.${done}"
        else
            echo "${warn}    Skipping Node.js installation.${done}"
        fi
    fi
}

# Create .envrc for Node.js project with rich info box
# Usage: create_node_envrc
create_node_envrc() {
    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD")}

    if [[ -f ".envrc" ]]; then
        echo "${info}.envrc already exists. (Skipping creation)${done}"
        return
    fi

    echo "${info}Creating .envrc with Node.js environment...${done}"

    cat <<'EOF' > .envrc
# PROJECT_NAME Node.js Environment

# Auto-switch Node version via nvm
if [[ -f ".nvmrc" ]] && command -v nvm &>/dev/null; then
    nvm use --silent 2>/dev/null || nvm use
fi

# Clear the "direnv: loading..." line
printf "\033[A\033[2K"

echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo -e "â”‚                        \033[32mğŸ“¦ PROJECT_NAME\033[0m                               â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "â”‚"
echo "â”‚  ğŸš€ Quick Start:"
echo "â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "â”‚     \033[3;33mpnpm dev\033[0m                   # Start dev server"
echo -e "â”‚     \033[3;33mpnpm test\033[0m                  # Run tests"
echo -e "â”‚     \033[3;33mpnpm build\033[0m                 # Build project"
echo "â”‚"
echo "â”‚  ğŸ“¦ Package Management:"
echo "â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "â”‚     \033[3;33mpnpm add <package>\033[0m         # Add dependency"
echo -e "â”‚     \033[3;33mpnpm add -D <package>\033[0m      # Add dev dependency"
echo -e "â”‚     \033[3;33mpnpm list\033[0m                  # List installed packages"
echo "â”‚"
echo "â”‚  ğŸ”§ Code Quality:"
echo "â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "â”‚     \033[3;33mpnpm exec eslint .\033[0m         # Lint code"
echo -e "â”‚     \033[3;33mpnpm exec prettier --write .\033[0m  # Format code"
echo "â”‚"
echo "â”‚  â„¹ï¸  Info:"
echo "â”‚  â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "â”‚     Node:    \033[36m$(node --version 2>/dev/null || echo 'N/A')\033[0m"
echo -e "â”‚     pnpm:    \033[36m$(pnpm --version 2>/dev/null || echo 'N/A')\033[0m"
echo -e "â”‚     Project: \033[36mPROJECT_NAME\033[0m"
local _pkg_version
_pkg_version=$(jq -r '.version // "0.1.0"' package.json 2>/dev/null || echo "0.1.0")
echo -e "â”‚     Version: \033[36m${_pkg_version}\033[0m"
echo "â”‚"
echo "â”‚  ğŸ”— Global Link Status:"
echo "â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if pnpm list --global 2>/dev/null | grep -q "PROJECT_NAME"; then
    echo -e "â”‚     Link:    \033[32mâœ“ Linked globally\033[0m"
else
    echo -e "â”‚     Link:    \033[33mâœ— Not linked globally\033[0m"
    echo -e "â”‚     Hint:    \033[3;33mnode_link\033[0m"
fi
echo "â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
EOF

    # Replace placeholder with actual project name
    sed -i.bak "s/PROJECT_NAME/$project_name/g" .envrc
    rm -f .envrc.bak

    # Allow direnv
    if command -v direnv &>/dev/null; then
        direnv allow .
    fi

    echo "${ok}.envrc created successfully.${done}"
}

# --- Project Lifecycle ---

# Scaffold a new Node.js project (TypeScript by default).
# Usage: node_new_project [--no-ts|--no-typescript|--js]
node_new_project() {
    local use_typescript=true

    # Parse arguments
    case "${1:-}" in
        --no-ts|--no-typescript|--js)
            use_typescript=false
            ;;
        "")
            ;;
        *)
            echo "${err}Unknown option: $1${done}" >&2
            echo "${info}Usage: node_new_project [--no-ts|--no-typescript|--js]${done}" >&2
            return 1
            ;;
    esac

    local project_name
    project_name=$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/_/g')

    if ! command -v pnpm &>/dev/null; then
        echo "${err}Error: 'pnpm' not found. Please ensure Corepack has prepared it.${done}" >&2
        return 1
    fi
    if ! command -v nvm &>/dev/null; then
        echo "${err}Error: 'nvm' not found.${done}" >&2
        return 1
    fi

    local current_node_version
    current_node_version=$(nvm current)
    if [[ "$current_node_version" == "none" ]]; then
        echo "${err}Error: No active Node.js version found.${done}" >&2
        echo "${info}Please run 'nvm install --lts' or 'nvm use <version>' first.${done}" >&2
        return 1
    fi

    local lang_label="TypeScript"
    [[ "$use_typescript" == false ]] && lang_label="JavaScript"

    echo "--------------------------------------------------"
    echo "${info}Creating new ${lang_label} project: ${ok}${project_name}${done}"
    echo "${info}Using Node: ${ok}${current_node_version}${done}"
    echo "--------------------------------------------------"

    # --- 1. Initialize project with pnpm ---
    echo "${info}Running: pnpm init${done}"
    pnpm init

    # Update project_name from package.json now that it exists
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/_/g')}

    # --- 2. Create standard project structure ---
    echo "${info}Creating directories: src/ and tests/${done}"
    mkdir -p src tests

    # --- 3. Create source and test files ---
    if [[ "$use_typescript" == true ]]; then
        echo "${info}Creating TypeScript source files...${done}"
        echo 'console.log("Hello, TypeScript project!");' > src/index.ts

        cat <<-'TESTEOF' > tests/index.test.ts
import { describe, it, expect } from 'vitest';

describe('initial test', () => {
    it('should pass', () => {
        expect(true).toBe(true);
    });
});
TESTEOF

        # Create tsconfig.json
        cat <<-'TSEOF' > tsconfig.json
{
    "compilerOptions": {
        "target": "ES2022",
        "module": "Node16",
        "moduleResolution": "Node16",
        "outDir": "dist",
        "rootDir": "src",
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "declaration": true,
        "declarationMap": true,
        "sourceMap": true
    },
    "include": ["src/**/*"],
    "exclude": ["node_modules", "dist", "tests"]
}
TSEOF
    else
        echo "${info}Creating JavaScript source files...${done}"
        echo 'console.log("Hello, Node.js project!");' > src/index.js

        cat <<-'TESTEOF' > tests/index.test.js
import { describe, it, expect } from 'vitest';

describe('initial test', () => {
    it('should pass', () => {
        expect(true).toBe(true);
    });
});
TESTEOF
    fi

    # --- 4. Create .nvmrc ---
    echo "${info}Creating .nvmrc with version: ${ok}${current_node_version}${done}"
    echo "$current_node_version" > .nvmrc

    # --- 5. Create .gitignore ---
    if [[ ! -f "./.gitignore" ]]; then
        echo "${info}Creating .gitignore...${done}"
        cat <<-'EOF' > .gitignore
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
pnpm-debug.log*
lerna-debug.log*

# Dependency directories
node_modules/
.pnp
.pnp.js

# Build output
dist/
build/
.next/
out/

# TypeScript
*.tsbuildinfo

# Test / Coverage
coverage/
.vitest/

# Cache
.turbo/
.eslintcache
.parcel-cache/
.swc/

# Other
.DS_Store
*.pem
.env
.env.local
.env.development.local
.env.test.local
.env.production.local
EOF
    fi

    # --- 6. Install dev dependencies ---
    if [[ "$use_typescript" == true ]]; then
        echo "${info}Installing dev dependencies (typescript, vitest, eslint, prettier, @types/node)...${done}"
        pnpm add -D typescript vitest eslint prettier @types/node
    else
        echo "${info}Installing dev dependencies (vitest, eslint, prettier)...${done}"
        pnpm add -D vitest eslint prettier
    fi

    # --- 7. Add scripts to package.json ---
    echo "${info}Adding scripts to package.json...${done}"
    if command -v jq &>/dev/null; then
        if [[ "$use_typescript" == true ]]; then
            jq '.scripts.dev = "pnpm dlx tsx --watch src/index.ts" |
                .scripts.build = "tsc" |
                .scripts.start = "node dist/index.js" |
                .scripts.test = "vitest run" |
                .scripts["test:watch"] = "vitest"' package.json > tmp.$$.json && mv tmp.$$.json package.json
        else
            jq '.scripts.dev = "node --watch src/index.js" |
                .scripts.start = "node src/index.js" |
                .scripts.test = "vitest run" |
                .scripts["test:watch"] = "vitest"' package.json > tmp.$$.json && mv tmp.$$.json package.json
        fi
    else
        echo "${warn}Warning: 'jq' not found. Please add scripts to package.json manually.${done}"
    fi

    # --- 8. Create .envrc if direnv is available ---
    if command -v direnv &>/dev/null; then
        create_node_envrc
    fi

    # --- 9. Final Success Message ---
    echo "--------------------------------------------------"
    echo "${ok}Project '${project_name}' setup complete!${done}"
    echo "--------------------------------------------------"

    _display_node_scripts
}

# Set up an existing Node.js project.
# Usage: node_setup
node_setup() {
    if [[ ! -f "package.json" ]]; then
        echo "${err}Error: 'package.json' not found. This does not appear to be a Node.js project.${done}" >&2
        _display_node_hints
        return 1
    fi

    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD")}

    echo "--------------------------------------------------"
    echo "${info}Setting up Node.js project: ${ok}${project_name}${done}"
    echo "--------------------------------------------------"

    # --- 1. Check for .nvmrc and ensure correct version ---
    if [[ -f ".nvmrc" ]]; then
        local required_version
        required_version=$(nvm version "$(cat .nvmrc)")
        if [[ "$(nvm version)" != "$required_version" ]]; then
            echo "${warn}Switching to project's required Node version...${done}"
            nvm use
        else
            echo "${ok}Correct Node version ($(nvm current)) is active.${done}"
        fi
    else
        echo "${warn}Warning: No .nvmrc file found. Using current Node version: $(nvm current)${done}"
    fi

    # --- 2. Install dependencies with pnpm ---
    if command -v pnpm &>/dev/null; then
        echo "${info}Installing dependencies with 'pnpm install'...${done}"
        if pnpm install; then
            echo "${ok}Dependencies installed successfully.${done}"
        else
            echo "${err}pnpm install failed. Please check the errors above.${done}"
            return 1
        fi
    else
        echo "${err}Error: 'pnpm' not found. Cannot install dependencies.${done}" >&2
        return 1
    fi

    # --- 3. Create .envrc if missing and direnv available ---
    if [[ ! -f ".envrc" ]] && command -v direnv &>/dev/null; then
        create_node_envrc
    fi

    echo "--------------------------------------------------"
    echo "${ok}Project setup complete.${done}"
    echo "--------------------------------------------------"

    _display_node_scripts
}

# Clean up Node.js project artifacts.
# Usage: node_clean
node_clean() {
    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD")}

    echo "--------------------------------------------------"
    echo "${info}Node.js Project Teardown: ${ok}${project_name}${done}"
    echo "--------------------------------------------------"

    local items_to_remove=(
        "node_modules"
        "dist"
        "build"
        ".next"
        "coverage"
        "pnpm-lock.yaml"
        ".turbo"
        ".eslintcache"
        ".tsbuildinfo"
        "out"
        ".parcel-cache"
        ".swc"
        ".vitest"
    )

    local deleted_something=false
    for item in "${items_to_remove[@]}"; do
        if [[ -e "$item" ]]; then
            echo "  ${warn}- Deleting: ${item}${done}"
            rm -rf "$item"
            deleted_something=true
        fi
    done

    if [[ "$deleted_something" = true ]]; then
        echo "${ok}Teardown complete.${done}"
    else
        echo "${info}No project files found to delete.${done}"
    fi
    echo "--------------------------------------------------"
}

# Quick project info dashboard.
# Usage: node_info
node_info() {
    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)

    echo "--------------------------------------------------"
    echo "${info}Node.js Environment Info${done}"
    echo "--------------------------------------------------"

    # Runtime versions
    echo "${info}  Node:     ${ok}$(node --version 2>/dev/null || echo 'not found')${done}"
    echo "${info}  npm:      ${ok}$(npm --version 2>/dev/null || echo 'not found')${done}"
    echo "${info}  pnpm:     ${ok}$(pnpm --version 2>/dev/null || echo 'not found')${done}"
    if command -v corepack &>/dev/null; then
        echo "${info}  Corepack: ${ok}$(corepack --version 2>/dev/null || echo 'not found')${done}"
    fi

    # .nvmrc status
    if [[ -f ".nvmrc" ]]; then
        local nvmrc_version
        nvmrc_version=$(cat .nvmrc)
        local current_version
        current_version=$(nvm current 2>/dev/null)
        if [[ "$(nvm version "$nvmrc_version" 2>/dev/null)" == "$(nvm version 2>/dev/null)" ]]; then
            echo "${ok}  .nvmrc:   ${nvmrc_version} (active)${done}"
        else
            echo "${warn}  .nvmrc:   ${nvmrc_version} (current: ${current_version})${done}"
        fi
    else
        echo "${warn}  .nvmrc:   not found${done}"
    fi

    # package.json info
    if [[ -n "$project_name" ]]; then
        local pkg_version
        pkg_version=$(jq -r '.version // "N/A"' package.json 2>/dev/null)
        echo "${info}  Project:  ${ok}${project_name}@${pkg_version}${done}"
    else
        echo "${warn}  Project:  no package.json found${done}"
    fi

    echo "--------------------------------------------------"

    # Scripts
    _display_node_scripts

    # Global link status
    if [[ -n "$project_name" ]]; then
        echo "--------------------------------------------------"
        echo "${info}Global Link Status:${done}"
        node_check_global
    fi

    echo "--------------------------------------------------"
}

# --- Global CLI Management ---

# Link current project globally via pnpm.
# Usage: node_link
node_link() {
    if [[ ! -f "package.json" ]]; then
        echo "${err}Error: 'package.json' not found.${done}" >&2
        return 1
    fi

    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD")}

    local current_node_version
    current_node_version=$(nvm current 2>/dev/null || node --version 2>/dev/null)

    echo "${info}Linking '${ok}${project_name}${info}' globally...${done}"
    if pnpm link --global; then
        echo "${ok}Successfully linked '${project_name}' globally.${done}"
        echo "${warn}Note: Global links are tied to current nvm Node version (${current_node_version}).${done}"
        echo "${info}Usage: Run '${example}${project_name}${info}' from anywhere.${done}"
    else
        echo "${err}Failed to link project globally.${done}" >&2
        return 1
    fi
}

# Unlink current project from global scope.
# Usage: node_unlink
node_unlink() {
    if [[ ! -f "package.json" ]]; then
        echo "${err}Error: 'package.json' not found.${done}" >&2
        return 1
    fi

    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)
    project_name=${project_name:-$(basename "$PWD")}

    echo "${info}Unlinking '${ok}${project_name}${info}' from global scope...${done}"
    if pnpm unlink --global 2>/dev/null; then
        echo "${ok}Successfully unlinked '${project_name}'.${done}"
    else
        echo "${warn}'${project_name}' was not linked globally (nothing to unlink).${done}"
    fi
}

# Check if current project is linked globally.
# Usage: node_check_global
# Returns 0 if linked, 1 if not.
node_check_global() {
    local project_name
    project_name=$(_get_node_project_name 2>/dev/null)

    if [[ -z "$project_name" ]]; then
        echo "${warn}  No package.json found â€” cannot check global link.${done}"
        return 1
    fi

    local current_node_version
    current_node_version=$(nvm current 2>/dev/null || node --version 2>/dev/null)
    local global_bin
    global_bin=$(pnpm bin --global 2>/dev/null)

    if pnpm list --global 2>/dev/null | grep -q "$project_name"; then
        echo "${ok}  '${project_name}' is linked globally${done}"
        echo "${info}  Node version: ${current_node_version}${done}"
        [[ -n "$global_bin" ]] && echo "${info}  Global bin:   ${global_bin}${done}"
        return 0
    else
        echo "${warn}  '${project_name}' is not linked globally${done}"
        return 1
    fi
}

# --- Zsh Completions ---

_node_new_project_completions() {
    _arguments \
        '1:options:((--no-ts\:"Scaffold JavaScript project" --no-typescript\:"Scaffold JavaScript project" --js\:"Scaffold JavaScript project"))'
}
compdef _node_new_project_completions node_new_project

# ==============================================================================
# Automatic NVM Check
# ==============================================================================
# Runs once per session to check if a default Node.js version is set.
if [[ -z "$_NVM_CHECK_COMPLETE" && -t 1 ]]; then
    nvm_check_and_install_lts
    export _NVM_CHECK_COMPLETE=true
fi
